<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>multi_chat</title>
</head>
<body>
<div class="wrapper">

    <header>
        <h1>AudioContext录音demo
        </h1>
    </header>

    <div class="my">
        <video autoplay id="my_video" width="100%" height="100%"></video>
    </div>
    <div>
        <input id="userId" type="text"/>
        <input id="url" type="text"/>
        <input type="button" onclick="addVideo(document.getElementById('userId').value, document.getElementById('url').value)">
    </div>

    <div class="other">
        <ul id="other_ul">

        </ul>
    </div>

</div>
</body>
<script>
    let peerConnections = {};
    let other_ul = document.getElementById("other_ul");

    let video = document.getElementById("my_video");
    console.info(video);
    function error(error){
        console.log("navigator.getUserMedia error:", error);
    }

    if (!navigator.getUserMedia) {
       alert("unsupported media!");
    } else {
       var constraints = {video: true, audio:{ echoCancellation : true, noiseSuppression : true }};
       // var constraints = {video:true,audio:true};
       navigator.getUserMedia(constraints, function(stream){
            video.srcObject = stream;

            for(let userId in peerConnections){
                pc = peerConnections[userId];
                if(pc){
                    for (const track of stream.getTracks()) {
                        pc.addTrack(track, stream);
                    }
                }
            }
       }, error);
    }

    function addConnection(userId, url){
        let pc = new RTCPeerConnection(url);
        peerConnections[userId] = pc;
    }

    function addVideo(userId, pc){
        let li = document.createElement("li");
        li.setAttribute("id", userId);
        let remote_video = document.createElement("video");
        pc.ontrack = ev =>{
            if(ev.streams && ev.streams[0]){
                remote_video.srcObject = ev.streams[0];
            } else {
                let inboundStream = new MediaStream(ev.track);
                remote_video.srcObject = inboundStream;
            }
        }
        li.append(remote_video);
        other_ul.append(li);
    }

    function removeConnection(userId){
        let pc = peerConnections[userId];
        if (pc) {
            pc.close();
            pc = null;
            peerConnections[userId] = null;
        }
    }
</script>
</html>